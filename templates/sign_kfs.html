{% extends "base.html" %}
{% block content %}

  <!-- White-only theme overrides for THIS page -->
  <style>
    :root{
      --bg:#ffffff !important;
      --surface:#ffffff !important;
      --card:#ffffff !important;
      --border:#e5e7eb !important;
      --fg:#111111 !important;
      --muted:#4b5563 !important;
      --ring:#3b82f6 !important;
      --ring-rgba: 59,130,246 !important;
      --inner-border:#e5e7eb !important;
    }
    html, body, .wrap { background:#ffffff !important; color:#111111 !important; }
    .nf-header, .nf-field, .kfs-wrapper { background:#ffffff !important; }
    .nf-header{ border:1px solid #e5e7eb !important; border-radius:14px; padding:24px; margin-bottom:20px; }
    .nf-title{ color:#111111 !important; }
    .nf-sub{ color:#4b5563 !important; }
    .nf-badge{
      background:rgba(59,130,246,.08) !important; border:1px solid rgba(59,130,246,.30) !important; color:#1f2937 !important;
    }

    .nf-field{
      border:1px solid #e5e7eb !important; border-radius:12px; padding:20px; margin:2px 0 16px;
    }
        .nf-field:nth-child(1){
      margin-top: 60px;
    }
    .nf-label{ color:#111111 !important; font-size:17px; }
    .nf-help{ color:#6b7280 !important; }
    .nf-error{ color:#b91c1c !important; }

    .nf-input, .nf-select, .nf-textarea, .nf-file{
      background:#ffffff !important; color:#111111 !important; border:1px solid #d1d5db !important;
    }
    .nf-input:focus, .nf-select:focus, .nf-textarea:focus, .nf-file:focus{
      border-color:#3b82f6 !important; box-shadow:0 0 0 3px rgba(59,130,246,.25) !important; outline:none;
    }
    .nf-check{ border-color:#d1d5db !important; background:#ffffff !important; }
    .nf-check:checked{ border-color:#3b82f6 !important; }

    .kfs-wrapper{
      border:1px solid #e5e7eb !important; border-radius:12px; padding:20px; margin-bottom:18px;
      box-shadow:0 8px 24px rgba(17,24,39,.06);
    }
    .kfs-content{ color:#111111; max-width:1100px; margin:0 auto; }
    .kfs-content p{ line-height:1.6; }
    .kfs-content h1, .kfs-content h2, .kfs-content h3{ color:#111111; margin-top:1.1em; }

    .nf-btn{ background:#2563eb !important; border-color:rgba(37,99,235,.6) !important; color:white !important; }
    .nf-btn:hover{ box-shadow:0 4px 18px rgba(37,99,235,.28); }

    .sig-box{
      background:#ffffff !important; border:1px solid #e5e7eb !important; border-radius:8px; padding:10px;
    }
  </style>

  <!-- Header -->
  <section class="nf-header">
    <h1 class="nf-title">{{ title or "Review & Sign KFS" }}</h1>
    <p class="nf-sub">Please review the Key Fact Sheet in full, then sign below to continue.</p>
  </section>

  <!-- Full-length KFS preview -->
  <section class="kfs-wrapper">
    <div class="kfs-content">
      {{ kfs_html|safe }}
    </div>
  </section>

  <div style="display:flex; justify-content:center; margin:16px 0 6px;">
    <a href="#sign-form" class="nf-btn" style="text-decoration:none;">Scroll to Sign</a>
  </div>

  <!-- Sign Form -->
  <form id="sign-form" class="nf-form" method="post" action="{{ url_for('kfs_sign_submit') }}" style="margin-top:12px;">
    <div class="nf-field">
      <label class="nf-label" for="signer_name">Full Name *</label>
      <input class="nf-input" type="text" name="signer_name" id="signer_name" value="{{ borrower_name or '' }}" required/>
    </div>

    <div class="nf-field">
      <label class="nf-label" for="signer_email">Email *</label>
      <input class="nf-input" type="email" name="signer_email" id="signer_email" placeholder="name@example.com" required/>
    </div>

    <div class="nf-field">
      <label class="nf-label">Signing Context</label>
      <div class="nf-help" style="color:#111;">
        IP: <strong>{{ sign_ctx.ip }}</strong> · Timestamp (UTC): <strong>{{ sign_ctx.now_utc }}</strong>
      </div>
    </div>

    <div class="nf-field">
      <label class="nf-label">Consent</label>
      <label class="nf-opt" for="consent">
        <input class="nf-check" type="checkbox" id="consent" required />
        <span style="color:#111">
          I, <span id="attn_name">{{ borrower_name or "the borrower" }}</span>, agree to sign the Key Fact Sheet electronically.
          I agree that my electronic signature is the legal equivalent of my manual/handwritten signature.
        </span>
      </label>
    </div>

    <div class="nf-field">
      <label class="nf-label">Signature *</label>
      <div class="sig-box">
        <canvas id="sig" width="1100" height="280" style="background:#ffffff; border-radius:6px; width:100%; height:auto;"></canvas>
      </div>
      <div class="nf-help">Sign with mouse or finger (on touch). Use “Clear” if you need to re-draw.</div>
      <div style="margin-top:10px; display:flex; gap:10px;">
        <button type="button" class="nf-btn" id="clearBtn" style="background:#374151 !important; border-color:#4b5563 !important;">Clear</button>
      </div>
    </div>

    <input type="hidden" name="sig_data_url" id="sig_data_url"/>
    <input type="hidden" name="attn_ip" value="{{ sign_ctx.ip }}"/>
    <input type="hidden" name="attn_ts_utc" value="{{ sign_ctx.now_utc }}"/>

    <div class="nf-actions" style="margin-top:8px;">
      <button class="nf-btn" type="submit">Sign & Continue</button>
    </div>
  </form>

  <!-- Signature logic (white canvas) -->
  <script>
    (function() {
      const nameInput = document.getElementById('signer_name');
      const attnName  = document.getElementById('attn_name');
      if (nameInput && attnName) {
        nameInput.addEventListener('input', () => {
          attnName.textContent = nameInput.value || '{{ borrower_name or "the borrower" }}';
        });
      }

      const canvas = document.getElementById('sig');
      const ctx = canvas.getContext('2d');

      function initSignaturePad() {
        const ratio = window.devicePixelRatio || 1;
        const cssWidth  = canvas.clientWidth || 1100;
        const cssHeight = Math.max(260, Math.floor(cssWidth * 0.25));
        canvas.width  = Math.floor(cssWidth * ratio);
        canvas.height = Math.floor(cssHeight * ratio);
        canvas.style.width  = cssWidth + "px";
        canvas.style.height = cssHeight + "px";

        if (ctx.reset) ctx.reset();
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 2.2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#1f2937'; /* dark ink over white */

        ctx.fillStyle = '#ffffff';    /* white background */
        ctx.fillRect(0, 0, cssWidth, cssHeight);
      }

      let drawing = false, last = null;
      function posFromEvent(e) {
        const rect = canvas.getBoundingClientRect();
        const t = (e.touches && e.touches[0]) || e;
        return { x: t.clientX - rect.left, y: t.clientY - rect.top };
      }
      function start(e){ drawing = true; last = posFromEvent(e); e.preventDefault(); }
      function move(e){
        if (!drawing) return;
        const p = posFromEvent(e);
        ctx.beginPath(); ctx.moveTo(last.x, last.y); ctx.lineTo(p.x, p.y); ctx.stroke();
        last = p; e.preventDefault();
      }
      function end(){ drawing = false; }

      canvas.addEventListener('mousedown', start);
      canvas.addEventListener('mousemove', move);
      window.addEventListener('mouseup', end);
      canvas.addEventListener('touchstart', start, {passive:false});
      canvas.addEventListener('touchmove',  move,  {passive:false});
      canvas.addEventListener('touchend',   end);

      document.getElementById('clearBtn').addEventListener('click', () => initSignaturePad());

      initSignaturePad();
      window.addEventListener('resize', initSignaturePad);

      // On submit: export high-res signature PNG on white
      document.getElementById('sign-form').addEventListener('submit', (e) => {
        const exportCanvas = document.createElement('canvas');
        const targetW = Math.min(1800, canvas.width);
        const targetH = Math.min(700,  canvas.height);
        exportCanvas.width = targetW; exportCanvas.height = targetH;
        const ex = exportCanvas.getContext('2d');
        ex.fillStyle = '#ffffff';  /* white export background */
        ex.fillRect(0,0,targetW,targetH);
        ex.drawImage(canvas, 0, 0, targetW, targetH);
        document.getElementById('sig_data_url').value = exportCanvas.toDataURL('image/png');
      });
    })();
  </script>

{% endblock %}
